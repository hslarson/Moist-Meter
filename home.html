<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="icon" href="https://i.ibb.co/F7P1bw1/icon.png">
	<title>Moist Meter List</title>


	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
		integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">
</head>

<body>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
		crossorigin="anonymous"></script>
	<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>


	<!-- Jumbotron (Top Banner) -->
	<div class="jumbotron text-center p-4 m-0" style="background-image: url('https://i.ibb.co/1QtnJ7X/pattern1.png');">
		<h1 class="display-4 text-white">Every Moist Meter</h1>
		<p class="mb-0" style="color:rgb(219, 219, 219)"><em>"I'm comin' in here raw, no rubber"</em> -Jesus</p>
	</div>

	<!-- Toolbar -->
	<div id="tableToolbar" class="d-flex flex-wrap justify-content-between align-items-center">

		<div class="flex-column">
			<input class="my-auto form-control" type="text" id="searchBox" placeholder="Search"/>
		</div>

		<div class="flex-column"></div>
			<button class="my-auto btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" id="tableFilter">Categories</button>
			<div class="dropdown-menu">
				<a class="dropdown-item" href="#" onclick="filterBy('All')">All</a>
				<div role="separator" class="dropdown-divider"></div>
				<a class="dropdown-item" href="#" onclick="filterBy('Movies')">Movies</a>
				<a class="dropdown-item" href="#" onclick="filterBy('TV Shows')">TV Shows</a>
				<a class="dropdown-item" href="#" onclick="filterBy('Video Games')">Video Games</a>
				<a class="dropdown-item" href="#" onclick="filterBy('Other')">Other</a>
			</div>
		</div>
	</div>

	<!-- Main Table -->
	<div class="px-1">
		<table id="table" class="table table-striped" data-search="true" data-custom-search="mySearch" data-search-selector="#searchBox" data-toolbar="#tableToolbar">

			<thead>
				<tr>
					<th class="d-none d-sm-table-cell" data-sortable="true" data-field="num">#</th>
					<th class="d-none d-lg-table-cell" data-field="date" data-formatter="dateFormatter">Date</th>
					<th data-visible="false" data-field="category"></th>
					<th data-searchable="true" data-formatter="titleFormatter" data-sortable="true" data-field="title_id">Title</th>
					<th data-sortable="true" data-field="score" data-formatter="scoreFormatter">Rating</th>
				</tr>
			</thead>

		</table>
	</div>
	

	<!-- Bottom Banner -->
	<div class="d-flex bg-light flex-wrap justify-content-between">
		<div class="flex-column text-center p-2">
			<p id="last_update" class="px-2 py-1 m-0 text-secondary text-small">last_update=1627881051</p>
		</div>
		<div class="flex-column text-center p-2">
			<p id="last_update" class="px-2 py-1 m-0 text-small"><a target="_blank" rel="noopener noreferrer" href="https://docs.google.com/forms/d/e/1FAIpQLScggit1tZFNKtu0xbJKTKuDEvtCjLYFtma41gjJiQzurMvqIg/viewform?usp=sf_link">Contact</a></p>
		</div>
	</div>


	<!-- Loads Data JSON and Creates Table -->
	<script>

		function titleSearch(data, search_target) {
			if (!search_target.length) { return data; }
			else { return data.filter(
				function (row) {
					var search_str = String(row.title_id).slice(0, String(row.title_id).indexOf("%%%"));
					return search_str.toLowerCase().includes( search_target.toLowerCase() );
				}
			)}
		}

		function filterSearch(data, filter_target) {
			if ('category' in filter_target) {
				var filter_val = filter_target['category'];
				if (filter_val == "All")
					return data;
				else
					return data.filter( function(row) { return row.category == filter_val; })
			}
		}

		function mySearch(data, text, colFilter) {
			
			if (typeof colFilter === 'undefined')
				return titleSearch(data, text);
			else
				return filterSearch(data, colFilter)
		}

		async function filterBy(val) {
			
			$('#tableFilter').html((val == "All" ? "Categories" : val));	
			$("#table").bootstrapTable('filterBy', {"category" : val});
		}

		async function get_json() {
			return await $.getJSON('./test_data.json');
			//return await $.getJSON('./.data.json');
		}

		$(async function() {
			var d = await get_json();
			var out = [];

			// Generate title/id string and number
			for (i in d) {
				if (!d[i].rated) continue;

				out.push({
					"num" : d.length - i,
					"date" : d[i].date,
					"category" : d[i].category,
					"title_id" : d[i].title + "%%%" + d[i].id,
					"score" : (isNaN(d[i].score) ? "000" : "") + d[i].score
				});
			}
			
			$('#table').bootstrapTable({ data: out });
			$(".bs-bars.float-left").first().removeClass('float-left');
		});

		$(function() {
			var substr = $("#last_update").text().replace("last_update=", "");
			$("#last_update").html( "Last Updated: " + dateFormatter(substr) );
		});

	</script>


	<!-- Formatters For Title and Date -->
	<script>
		function dateFormatter(value) {
			var d = new Date(value * 1000);
			return ('0' + (d.getMonth() + 1)).slice(-2) + "/" + ('0' + d.getDate()).slice(-2) + "/" + d.getFullYear().toString().substr(-2)
		}

		function titleFormatter(value) {
			const split_chars = "%%%"
			let temp = value.split(split_chars);

			return "<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://www.youtube.com/watch?v=" + temp[1] + "\">" + temp[0] + "</a>";
		}

		function scoreFormatter(value) {
			return value.replace("000", "");
		}
	</script>

	<script>

	</script>

</body>

</html>